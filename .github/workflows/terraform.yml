name: Terraform CI/CD

on:
  pull_request:
    branches: [main, develop]
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - ".github/workflows/terraform.yml"
  push:
    branches: [main, develop]
    paths:
      - "**/*.tf"
      - "**/*.tfvars"
      - ".github/workflows/terraform.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment"
        required: true
        type: choice
        options: [dev, staging, prod]
      group:
        description: "Grupo / namespace do state (ex: grupo19)"
        required: true
        default: "grupo19"
      mode:
        description: "Mode"
        required: true
        type: choice
        options: [plan, apply]
      adopt_existing:
        description: "Importar (adotar) recursos existentes ANTES do apply? (SOMENTE prod)"
        required: true
        type: choice
        options: ["false", "true"]
        default: "false"

env:
  TF_VERSION: "1.13.0"
  AWS_REGION: "us-east-1"
  TF_GROUP_DEFAULT: "grupo19"

  # ===== ADOPT DEFAULTS (PROD) =====
  ADOPT_VPC_ID_PROD: "vpc-0d6e40297ef06fdaf"
  ADOPT_SG_NAME_PROD: "tech-challenge-rds-sg-prod"
  ADOPT_DB_INSTANCE_ID_PROD: "tech-challenge-mysql-prod"

  ADOPT_IAM_ROLE_NAME_PROD: "tech-challenge-rds-enhanced-monitoring-prod"
  ADOPT_PARAM_GROUP_NAME: "tech-challenge-mysql-params"
  ADOPT_DB_SUBNET_GROUP_PROD: "tech-challenge-db-subnet-group-prod"

  ADOPT_SECRET_MASTER: "tech-challenge/rds/mysql/master-credentials"
  ADOPT_SECRET_APP: "tech-challenge/rds/mysql/app-credentials"
  ADOPT_SECRET_MIGRATION: "tech-challenge/rds/mysql/migration-credentials"
  ADOPT_SECRET_ADMIN: "tech-challenge/rds/mysql/admin-credentials"

  ADOPT_IAM_POLICY_APP_SECRETS_READ: "tech-challenge-app-secrets-read"
  ADOPT_IAM_POLICY_MIGRATION_SECRETS_READ: "tech-challenge-migration-secrets-read"

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: terraform-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Terraform fmt
        run: terraform fmt -check -diff -recursive

      - name: Terraform init (no backend)
        run: terraform init -backend=false

      - name: Terraform validate
        run: terraform validate

  plan_pr:
    name: Plan (PR)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request'
    strategy:
      fail-fast: false
      matrix:
        env: [dev, staging, prod]
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Terraform init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=infra/${{ env.TF_GROUP_DEFAULT }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"

      - name: Terraform plan
        shell: bash
        run: |
          set -euo pipefail
          terraform plan \
            -input=false \
            -var-file=terraform.${{ matrix.env }}.tfvars \
            -no-color | tee tfplan-${{ matrix.env }}.txt
        continue-on-error: true

      - uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ matrix.env }}-txt
          path: tfplan-${{ matrix.env }}.txt

  deploy:
    name: Deploy - ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment:
      name: ${{ github.event.inputs.environment }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install jq
        shell: bash
        run: |
          set -euo pipefail
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y jq
          fi

      - name: Terraform init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TERRAFORM_STATE_BUCKET }}" \
            -backend-config="key=infra/${{ github.event.inputs.group }}/${{ github.event.inputs.environment }}/terraform.tfstate" \
            -backend-config="region=${{ env.AWS_REGION }}"

      - name: Unschedule deleted Secrets (if any)
        if: github.event.inputs.mode == 'apply'
        shell: bash
        run: |
          set -euo pipefail

          ensure_secret_active () {
            secret_name="$1"

            if ! aws secretsmanager describe-secret --secret-id "$secret_name" > /tmp/secret.json 2>/dev/null; then
              echo "Secret not found: $secret_name (Terraform will create it)."
              return 0
            fi

            deleted_date="$(jq -r '.DeletedDate // empty' /tmp/secret.json)"

            if [ -n "$deleted_date" ]; then
              echo "Secret scheduled for deletion: $secret_name (DeletedDate=$deleted_date). Cancelling..."
              aws secretsmanager cancel-delete-secret --secret-id "$secret_name" >/dev/null
              echo "Cancelled deletion: $secret_name"
            else
              echo "Secret active: $secret_name"
            fi
          }

          ensure_secret_active "${{ env.ADOPT_SECRET_MASTER }}"
          ensure_secret_active "${{ env.ADOPT_SECRET_APP }}"
          ensure_secret_active "${{ env.ADOPT_SECRET_MIGRATION }}"
          ensure_secret_active "${{ env.ADOPT_SECRET_ADMIN }}"

      - name: Adopt existing resources (prod)
        if: github.event.inputs.adopt_existing == 'true' && github.event.inputs.environment == 'prod'
        shell: bash
        run: |
          set -euo pipefail

          tf_import () {
            addr="$1"
            id="$2"

            if terraform state show "$addr" >/dev/null 2>&1; then
              echo "[SKIP] already in state: $addr"
              return 0
            fi

            if [ -z "$id" ] || [ "$id" = "None" ] || [ "$id" = "null" ]; then
              echo "[WARN] empty id for $addr. Skipping import."
              return 0
            fi

            echo "[IMPORT] $addr <= $id"
            terraform import -input=false -var-file="terraform.${{ github.event.inputs.environment }}.tfvars" "$addr" "$id"
          }

          SG_ID="$(aws ec2 describe-security-groups \
            --filters "Name=vpc-id,Values=${{ env.ADOPT_VPC_ID_PROD }}" "Name=group-name,Values=${{ env.ADOPT_SG_NAME_PROD }}" \
            --query "SecurityGroups[0].GroupId" --output text)"

          APP_POLICY_ARN="$(aws iam list-policies --scope Local \
            --query "Policies[?PolicyName=='${{ env.ADOPT_IAM_POLICY_APP_SECRETS_READ }}'].Arn | [0]" \
            --output text)"

          MIG_POLICY_ARN="$(aws iam list-policies --scope Local \
            --query "Policies[?PolicyName=='${{ env.ADOPT_IAM_POLICY_MIGRATION_SECRETS_READ }}'].Arn | [0]" \
            --output text)"

          tf_import aws_security_group.rds "$SG_ID"
          tf_import aws_db_instance.mysql "${{ env.ADOPT_DB_INSTANCE_ID_PROD }}"
          tf_import aws_iam_role.rds_enhanced_monitoring "${{ env.ADOPT_IAM_ROLE_NAME_PROD }}"
          tf_import aws_db_parameter_group.mysql "${{ env.ADOPT_PARAM_GROUP_NAME }}"
          tf_import aws_db_subnet_group.main "${{ env.ADOPT_DB_SUBNET_GROUP_PROD }}"

          tf_import aws_secretsmanager_secret.db_master_credentials "${{ env.ADOPT_SECRET_MASTER }}"
          tf_import aws_secretsmanager_secret.db_app_credentials "${{ env.ADOPT_SECRET_APP }}"
          tf_import aws_secretsmanager_secret.db_migration_credentials "${{ env.ADOPT_SECRET_MIGRATION }}"
          tf_import aws_secretsmanager_secret.db_admin_credentials "${{ env.ADOPT_SECRET_ADMIN }}"

          tf_import aws_iam_policy.app_secrets_read "$APP_POLICY_ARN"
          tf_import aws_iam_policy.migration_secrets_read "$MIG_POLICY_ARN"

      - name: Terraform plan (dispatch)
        if: github.event.inputs.mode == 'plan'
        shell: bash
        run: |
          set -euo pipefail
          terraform plan \
            -input=false \
            -var-file="terraform.${{ github.event.inputs.environment }}.tfvars" \
            -no-color | tee tfplan-dispatch-${{ github.event.inputs.environment }}.txt

      - uses: actions/upload-artifact@v4
        if: github.event.inputs.mode == 'plan'
        with:
          name: tfplan-dispatch-${{ github.event.inputs.environment }}-txt
          path: tfplan-dispatch-${{ github.event.inputs.environment }}.txt

      - name: Terraform apply
        if: github.event.inputs.mode == 'apply'
        shell: bash
        run: |
          set -euo pipefail
          terraform apply \
            -auto-approve \
            -input=false \
            -var-file="terraform.${{ github.event.inputs.environment }}.tfvars"
